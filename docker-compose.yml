version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: animal_counter_db
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: animal_counter
    volumes:
      - mongodb_data:/data/db
    ports:
      - "127.0.0.1:27017:27017"  # Only accessible from host/containers
    networks:
      - animal_counter_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Service (handles processing)
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/yourusername/peacock-villa-animal-counter:latest
    container_name: animal_counter_api
    restart: unless-stopped
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DB=animal_counter
      - UPLOAD_DIR=/app/uploads
      - RESULTS_DIR=/app/results
      - DEVICE=cpu
      - API_PORT=8000
    volumes:
      - uploads_data:/app/uploads
      - results_data:/app/results
      - ./logs:/app/logs
    ports:
      - "8000:8000"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - animal_counter_network
    command: python3 -m uvicorn animal_counter.api.main:app --host 0.0.0.0 --port 8000

  # Upload Service (handles file uploads)
  upload:
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/yourusername/peacock-villa-animal-counter:latest
    container_name: animal_counter_upload
    restart: unless-stopped
    environment:
      - API_SERVICE_URL=http://api:8000
      - UPLOAD_DIR=/app/uploads
    volumes:
      - uploads_data:/app/uploads
      - ./logs:/app/logs
    ports:
      - "8001:8001"
    depends_on:
      - api
    networks:
      - animal_counter_network
    # Command will be set when we create the upload service

  # Nginx (reverse proxy + static file serving)
  nginx:
    image: nginx:alpine
    container_name: animal_counter_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - results_data:/var/www/results:ro
      - ./frontend/build:/var/www/html:ro
    depends_on:
      - api
      - upload
    networks:
      - animal_counter_network

networks:
  animal_counter_network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  uploads_data:
    driver: local
  results_data:
    driver: local
